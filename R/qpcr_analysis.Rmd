---
title: "qpcr analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath(".."))
```

##Load R Package
This will load the R package devtools (installation script commented in), as well as the code for the qPCR plates
```{r libraries}
library(devtools)  # install.packages("devtools")
#devtools::install_github("jrcunning/steponeR")
library(steponeR)
library(tidyverse)
```

##Loading qPCR Data from a Text File
This will load a .txt file and read the data in it to calculate symbiont/host cell ratios. *NOTE*: in future will need to add a few arguments (flour.num, copy.number, ploidy, extract) in order to use data. For help use "?steponeR"
```{r load_data}
plates <- list.files(path = "data/qpcr", pattern = ".txt", full.names = TRUE)
plates

metadata <- list.files(path = "data/other", pattern = ".csv", full.names = TRUE)
metadata

df1 <- read.table(file = "data/other/coral_history.csv", fill = TRUE, nrows = 126, header = T, sep = ",") #creates a dataframe of the coral metadata from a csv file

df <- steponeR(files = plates, 
         delim = "\t", 
         target.ratios = c("C.Ssid", "D.Ssid"), 
         fluor.norm = list(C = 2.5, D = 0, Ssid = 2.5),
         copy.number = list(C = 20, D = 1, Ssid = 1),
         ploidy = list(C=1, D=1, Ssid=2),
         extract = list(C=0.813, D=0.813, Ssid=0.982))
qpcr <- df$result



qpcr <- filter(qpcr, nchar(Sample.Name) == 8 | nchar(Sample.Name) == 9) #filters out the NTC and positive controls


qpcr <- separate(qpcr, Sample.Name, c("genotype", "individual", "timepoint"), sep = "-")

qpcr <- unite(qpcr, Sample.Name, 1:2, sep = "-")


fulltable <- full_join(qpcr, df1)


fulltable <- fulltable %>%
  mutate(date = case_when(timepoint == "T0" ~ as.Date("2018-01-31"),
                          timepoint == "T1" ~ as.Date("2018-02-12"),
                          timepoint == "T2" ~ as.Date("2018-03-26"),
                          timepoint == "T3" ~ as.Date("2018-05-23"),
                          timepoint == "T4" ~ as.Date("2018-05-30")),
         C.Ssid1 = case_when(is.na(C.Ssid) == TRUE ~ 0,
                             TRUE ~ C.Ssid),
         D.Ssid1 = case_when(is.na(D.Ssid) == TRUE ~ 0,
                             TRUE ~ D.Ssid),
         totalSH = C.Ssid1 + D.Ssid1,
         propD = D.Ssid1 / totalSH,)

redos <- filter(fulltable1, totalSH > 0.5) #samples that need to be done due to high S/H cell ratios



#aesthetics - details of plot
ggplot(fulltable1, aes(x = date, y = log10(C.Ssid))) +
  geom_point()

#Plots of standard devs between technical replicates
ggplot(qpcr, aes(x = C.CT.sd)) +
  geom_histogram(breaks = seq(0,3,by=.1))

ggplot(qpcr, aes(x = D.CT.sd)) +
  geom_histogram(breaks = seq(0,3,by=.1))

ggplot(qpcr, aes(x = Ssid.CT.sd)) +
  geom_histogram(breaks = seq(0,3,by=.1))

#boxplot to display different genotypes' SH ratios at different time points

#first I need a table with just Ssid in it

Ssid <- filter(fulltable, Geno == 21 | Geno == 25 | Geno == 26)
Ssid <- filter(Ssid, totalSH > 0)
Ssid$Geno <- as.factor(Ssid$Geno) #allows the genotypes to be treated as discrete instead of continuous
Ssid$totalSH_log <- log10(Ssid$totalSH)

Ssid_SH_plot <- ggplot(Ssid, aes(group = Geno, x = Geno, y = log10(totalSH))) +
  geom_boxplot() +
  ggtitle("Symbiont to Host Cell Ratios of S. siderea") +
  xlab("Genotype") + ylab("Symbiont/Host Cell Ratio") +
  facet_wrap(vars(timepoint))
  
Ssid_SH_plot

#Next step to plot C - D ratios pre and post recovery, one of Ross's past papers used innitial proportion clade D on x axis and recovered proportion clade D on the y axis, I think I need to separate fulltable into separate timepoint dataframes. In hindsight it would have been WAY easier to split the dataframe AFTER all the other stuff, but live and learn

t0 <- filter(fulltable, grepl("T0", timepoint))
t1 <- filter(fulltable, grepl("T1", timepoint))
t2 <- filter(fulltable, grepl("T2", timepoint))
t3 <- filter(fulltable, grepl("T3", timepoint))

#Filter out any NaN values

t0 <- filter(t0, propD > 0 & propD < 1.1)
t1 <- filter(t1, propD > 0 & propD < 1.1)
t2 <- filter(t2, propD > 0 & propD < 1.1)
t3 <- filter(t3, propD > 0 & propD < 1.1)

#Also need to rename the column names so the propD is identifiable to sprecific timepoints

colnames(t0)[colnames(t0) == "propD"] <- "propD.t0"
colnames(t1)[colnames(t1) == "propD"] <- "propD.t1"
colnames(t2)[colnames(t2) == "propD"] <- "propD.t2"
colnames(t3)[colnames(t3) == "propD"] <- "propD.t3"

#creating a table that has only the info needed for graphing and columns that are unique except for sample name so when I join them all the sample info for a certain coral ID will be on the same row

T0 <- t0[c(1,24)]
T1 <- t1[c(1,24)]
T2 <- t2[c(1,24)]
T3 <- t3[c(1,24)]

#time to join the timepoints into one table

propD_df <- full_join(T0, T1)
propD_df <- full_join(propD_df, T2)
propD_df <- full_join(propD_df, T3)

#Now that the proportion of D of the symbionts at each timepoint is on the same row of a dataframe, I can use that dataframe to look at any two timepoints I need to

propD_t0t2 <- ggplot(propD_df, aes(x = propD.t0, y = propD.t2)) + 
  geom_point() +
  ggtitle("S. siderea Proportion of Clade D Before and After First Stress") +
  xlab("Initial Proportion of Clade D") + ylab("Post-Stress Proportion of Clade D") +
  #xlim(0,1) +
  #ylim(0,1) +
  geom_abline(intercept = 0, slope = 1)
  
propD_t0t2

#Looking to see if there's any correlation between treatment and which way the coral shuffled, towards D or C

HT_df <- filter(fulltable, Treatment.1 == "HT")
HL_df <- filter(fulltable, Treatment.1 == "HL")
C_df <- filter(fulltable, Treatment.1 == "C")

#Now just plotted the same way as before

#-------------------------------------HIGH HEAT-----------------------------------------

#Next step to plot C - D ratios pre and post recovery, one of Ross's past papers used innitial proportion clade D on x axis and recovered proportion clade D on the y axis, I think I need to separate fulltable into separate timepoint dataframes. In hindsight it would have been WAY easier to split the dataframe AFTER all the other stuff, but live and learn

t0_HT <- filter(HT_df, grepl("T0", timepoint))
t1_HT <- filter(HT_df, grepl("T1", timepoint))
t2_HT <- filter(HT_df, grepl("T2", timepoint))
t3_HT <- filter(HT_df, grepl("T3", timepoint))

#Filter out any NaN values

t0_HT <- filter(t0_HT, propD > 0 & propD < 1.1)
t1_HT <- filter(t1_HT, propD > 0 & propD < 1.1)
t2_HT <- filter(t2_HT, propD > 0 & propD < 1.1)
t3_HT <- filter(t3_HT, propD > 0 & propD < 1.1)

#Also need to rename the column names so the propD is identifiable to sprecific timepoints

colnames(t0_HT)[colnames(t0_HT) == "propD"] <- "propD.t0_HT"
colnames(t1_HT)[colnames(t1_HT) == "propD"] <- "propD.t1_HT"
colnames(t2_HT)[colnames(t2_HT) == "propD"] <- "propD.t2_HT"
colnames(t3_HT)[colnames(t3_HT) == "propD"] <- "propD.t3_HT"

#creating a table that has only the info needed for graphing and columns that are unique except for sample name so when I join them all the sample info for a certain coral ID will be on the same row

T0_HT <- t0_HT[c(1,24)]
T1_HT <- t1_HT[c(1,24)]
T2_HT <- t2_HT[c(1,24)]
T3_HT <- t3_HT[c(1,24)]

#time to join the timepoints into one table

propD_HT <- full_join(T0_HT, T1_HT)
propD_HT <- full_join(propD_HT, T2_HT)
propD_HT <- full_join(propD_HT, T3_HT)

#Now that the proportion of D of the symbionts at each timepoint is on the same row of a dataframe, I can use that dataframe to look at any two timepoints I need to

propD_t0t2_HT <- ggplot(propD_HT, aes(x = propD.t0_HT, y = propD.t2_HT)) + 
  geom_point() +
  ggtitle("S. siderea Proportion of Clade D Before and After Heat Stress") +
  xlab("Initial Proportion of Clade D") + ylab("Post-Stress Proportion of Clade D") +
  #xlim(0,1) +
  #ylim(0,1) +
  geom_abline(intercept = 0, slope = 1)
propD_t0t2_HT

#-----------------------------------------------------------------------------------------

#---------------------------------------HIGH LIGHT----------------------------------------

#Next step to plot C - D ratios pre and post recovery, one of Ross's past papers used innitial proportion clade D on x axis and recovered proportion clade D on the y axis, I think I need to separate fulltable into separate timepoint dataframes. In hindsight it would have been WAY easier to split the dataframe AFTER all the other stuff, but live and learn

t0_HL <- filter(HL_df, grepl("T0", timepoint))
t1_HL <- filter(HL_df, grepl("T1", timepoint))
t2_HL <- filter(HL_df, grepl("T2", timepoint))
t3_HL <- filter(HL_df, grepl("T3", timepoint))

#Filter out any NaN values

t0_HL <- filter(t0_HL, propD > 0 & propD < 1.1)
t1_HL <- filter(t1_HL, propD > 0 & propD < 1.1)
t2_HL <- filter(t2_HL, propD > 0 & propD < 1.1)
t3_HL <- filter(t3_HL, propD > 0 & propD < 1.1)

#Also need to rename the column names so the propD is identifiable to sprecific timepoints

colnames(t0_HL)[colnames(t0_HL) == "propD"] <- "propD.t0_HL"
colnames(t1_HL)[colnames(t1_HL) == "propD"] <- "propD.t1_HL"
colnames(t2_HL)[colnames(t2_HL) == "propD"] <- "propD.t2_HL"
colnames(t3_HL)[colnames(t3_HL) == "propD"] <- "propD.t3_HL"

#creating a table that has only the info needed for graphing and columns that are unique except for sample name so when I join them all the sample info for a certain coral ID will be on the same row

T0_HL <- t0_HL[c(1,24)]
T1_HL <- t1_HL[c(1,24)]
T2_HL <- t2_HL[c(1,24)]
T3_HL <- t3_HL[c(1,24)]

#time to join the timepoints into one table

propD_HL <- full_join(T0_HL, T1_HL)
propD_HL <- full_join(propD_HL, T2_HL)
propD_HL <- full_join(propD_HL, T3_HL)

#Now that the proportion of D of the symbionts at each timepoint is on the same row of a dataframe, I can use that dataframe to look at any two timepoints I need to

propD_t0t2_HL <- ggplot(propD_HL, aes(x = propD.t0_HL, y = propD.t2_HL)) + 
  geom_point() +
  ggtitle("S. siderea Proportion of Clade D Before and After Light Stress") +
  xlab("Initial Proportion of Clade D") + ylab("Post-Stress Proportion of Clade D") +
  #xlim(0,1) +
  #ylim(0,1) +
  geom_abline(intercept = 0, slope = 1)

propD_t0t2_HL

#-----------------------------------------------------------------------------------------

#-------------------------------------CONTROL---------------------------------------------

#Next step to plot C - D ratios pre and post recovery, one of Ross's past papers used innitial proportion clade D on x axis and recovered proportion clade D on the y axis, I think I need to separate fulltable into separate timepoint dataframes. In hindsight it would have been WAY easier to split the dataframe AFTER all the other stuff, but live and learn

t0_C <- filter(C_df, grepl("T0", timepoint))
t1_C <- filter(C_df, grepl("T1", timepoint))
t2_C <- filter(C_df, grepl("T2", timepoint))
t3_C <- filter(C_df, grepl("T3", timepoint))

#Filter out any NaN values

t0_C <- filter(t0_C, propD > 0 & propD < 1.1)
t1_C <- filter(t1_C, propD > 0 & propD < 1.1)
t2_C <- filter(t2_C, propD > 0 & propD < 1.1)
t3_C <- filter(t3_C, propD > 0 & propD < 1.1)

#Also need to rename the column names so the propD is identifiable to sprecific timepoints

colnames(t0_C)[colnames(t0_C) == "propD"] <- "propD.t0_C"
colnames(t1_C)[colnames(t1_C) == "propD"] <- "propD.t1_C"
colnames(t2_C)[colnames(t2_C) == "propD"] <- "propD.t2_C"
colnames(t3_C)[colnames(t3_C) == "propD"] <- "propD.t3_C"

#creating a table that has only the info needed for graphing and columns that are unique except for sample name so when I join them all the sample info for a certain coral ID will be on the same row

T0_C <- t0_C[c(1,24)]
T1_C <- t1_C[c(1,24)]
T2_C <- t2_C[c(1,24)]
T3_C <- t3_C[c(1,24)]

#time to join the timepoints into one table

propD_C <- full_join(T0_C, T1_C)
propD_C <- full_join(propD_C, T2_C)
propD_C <- full_join(propD_C, T3_C)

#Now that the proportion of D of the symbionts at each timepoint is on the same row of a dataframe, I can use that dataframe to look at any two timepoints I need to

propD_t0t2_C <- ggplot(propD_C, aes(x = propD.t0_C, y = propD.t2_C)) + 
  geom_point() +
  ggtitle("S. siderea Proportion of Clade D in Control Conditions") +
  xlab("Initial Proportion of Clade D") + ylab("Post-Stress Proportion of Clade D") +
  #xlim(0,1) +
  #ylim(0,1) +
  geom_abline(intercept = 0, slope = 1)

propD_t0t2_C

#-----------------------------------------------------------------------------------------
```
*NOTE*: The object "plates" is a list of all of the .txt files in the data/qpcr folder