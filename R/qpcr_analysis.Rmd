---
title: "qpcr analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath(".."))
```

##Load R Package
This will load the R package devtools (installation script commented in), as well as the code for the qPCR plates
```{r libraries}
library(devtools)  # install.packages("devtools")
#devtools::install_github("jrcunning/steponeR")
library(steponeR)
library(tidyverse)
```

##Loading qPCR Data from a Text File
This will load a .txt file and read the data in it to calculate symbiont/host cell ratios. *NOTE*: in future will need to add a few arguments (flour.num, copy.number, ploidy, extract) in order to use data. For help use "?steponeR"
```{r load_data}
plates <- list.files(path = "data/qpcr", pattern = ".txt", full.names = TRUE)
plates

metadata <- list.files(path = "data/other", pattern = ".csv", full.names = TRUE)
metadata

df1 <- read.table(file = "data/other/coral_history.csv", fill = TRUE, nrows = 126, header = T, sep = ",") #creates a dataframe of the coral metadata from a csv file

df <- steponeR(files = plates, 
         delim = "\t", 
         target.ratios = c("C.Ssid", "D.Ssid"), 
         fluor.norm = list(C = 2.5, D = 0, Ssid = 2.5),
         copy.number = list(C = 20, D = 1, Ssid = 1),
         ploidy = list(C=1, D=1, Ssid=2),
         extract = list(C=0.813, D=0.813, Ssid=0.982))
qpcr <- df$result



qpcr <- filter(qpcr, nchar(Sample.Name) == 8 | nchar(Sample.Name) == 9) #filters out the NTC and positive controls


qpcr <- separate(qpcr, Sample.Name, c("genotype", "individual", "timepoint"), sep = "-")

qpcr <- unite(qpcr, Sample.Name, 1:2, sep = "-")


fulltable <- full_join(qpcr, df1)


fulltable <- fulltable %>%
  mutate(date = case_when(timepoint == "T0" ~ as.Date("2018-01-31"),
                          timepoint == "T1" ~ as.Date("2018-02-12"),
                          timepoint == "T2" ~ as.Date("2018-03-26"),
                          timepoint == "T3" ~ as.Date("2018-05-23"),
                          timepoint == "T4" ~ as.Date("2018-05-30")),
         C.Ssid1 = case_when(is.na(C.Ssid) == TRUE ~ 0,
                             TRUE ~ C.Ssid),
         D.Ssid1 = case_when(is.na(D.Ssid) == TRUE ~ 0,
                             TRUE ~ D.Ssid),
         totalSH = C.Ssid1 + D.Ssid1,
         propD = D.Ssid1 / totalSH,)

redos <- filter(fulltable1, totalSH > 0.5) #samples that need to be done due to high S/H cell ratios



#aesthetics - details of plot
ggplot(fulltable1, aes(x = date, y = log10(C.Ssid))) +
  geom_point()

#Plots of standard devs between technical replicates
ggplot(qpcr, aes(x = C.CT.sd)) +
  geom_histogram(breaks = seq(0,3,by=.1))

ggplot(qpcr, aes(x = D.CT.sd)) +
  geom_histogram(breaks = seq(0,3,by=.1))

ggplot(qpcr, aes(x = Ssid.CT.sd)) +
  geom_histogram(breaks = seq(0,3,by=.1))

#boxplot to display different genotypes' SH ratios at different time points

#first I need a table with just Ssid in it
Ssid <- filter(fulltable, Geno == 21 | Geno == 25 | Geno == 26)
Ssid <- filter(Ssid, totalSH > 0)
Ssid$Geno <- as.factor(Ssid$Geno) #allows the genotypes to be treated as discrete instead of continuous

Ssid_SH_plot <- ggplot(Ssid, aes(group = Geno, x = Geno, y = totalSH)) +
  geom_boxplot() +
  ylim(0, .2) +
  
  ggtitle("Symbiont to Host Cell Ratios of S. siderea") +
  xlab("Genotype") + ylab("Symbiont/Host Cell Ratio") +
  facet_wrap(vars(timepoint))
  
Ssid_SH_plot
```
*NOTE*: The object "plates" is a list of all of the .txt files in the data/qpcr folder


